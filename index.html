import tkinter as tk
from tkinter import messagebox, filedialog
import os
import json

# Constants
ATTENDANCE_THRESHOLD = 75  # Percent
TOTAL_DAYS = 100  # Total class days (can be changed)


class AttendanceCalculator(tk.Tk):
    def __init__(self):
        super().__init__()
        self.title("Attendance Calculator")
        self.geometry("600x400")
        self.configure(bg="black")

        self.students = {}  # {name: days_attended}

        self.create_widgets()
        self.filename = None

    def create_widgets(self):
        # Title Label
        title = tk.Label(self, text="Attendance Calculator", font=("Arial", 20, "bold"), bg="black", fg="yellow")
        title.pack(pady=10)

        # Entry frame
        frame = tk.Frame(self, bg="black")
        frame.pack(pady=10)

        tk.Label(frame, text="Student Name:", bg="black", fg="yellow").grid(row=0, column=0, padx=5)
        self.entry_name = tk.Entry(frame)
        self.entry_name.grid(row=0, column=1, padx=5)

        tk.Label(frame, text="Days Attended:", bg="black", fg="yellow").grid(row=1, column=0, padx=5)
        self.entry_days = tk.Entry(frame)
        self.entry_days.grid(row=1, column=1, padx=5)

        btn_add = tk.Button(frame, text="Add/Update", bg="yellow", fg="black", command=self.add_update_student)
        btn_add.grid(row=2, column=0, columnspan=2, pady=10)

        # Student Listbox and scrollbar
        list_frame = tk.Frame(self, bg="black")
        list_frame.pack(pady=10, fill="both", expand=True)

        scrollbar = tk.Scrollbar(list_frame)
        scrollbar.pack(side="right", fill="y")

        self.listbox = tk.Listbox(list_frame, bg="black", fg="yellow", font=("Arial", 12), yscrollcommand=scrollbar.set)
        self.listbox.pack(fill="both", expand=True)
        scrollbar.config(command=self.listbox.yview)

        # Buttons frame
        btn_frame = tk.Frame(self, bg="black")
        btn_frame.pack(pady=10)

        btn_calc = tk.Button(btn_frame, text="Calculate Bunk Days", bg="yellow", fg="black", command=self.calculate_bunk)
        btn_calc.grid(row=0, column=0, padx=5)

        btn_save = tk.Button(btn_frame, text="Save Data", bg="yellow", fg="black", command=self.save_data)
        btn_save.grid(row=0, column=1, padx=5)

        btn_load = tk.Button(btn_frame, text="Load Data", bg="yellow", fg="black", command=self.load_data)
        btn_load.grid(row=0, column=2, padx=5)

        btn_clear = tk.Button(btn_frame, text="Clear All", bg="yellow", fg="black", command=self.clear_all)
        btn_clear.grid(row=0, column=3, padx=5)

    def add_update_student(self):
        name = self.entry_name.get().strip()
        days_str = self.entry_days.get().strip()

        if not name:
            messagebox.showerror("Input Error", "Please enter a student name.")
            return
        if not days_str.isdigit():
            messagebox.showerror("Input Error", "Days attended must be a positive number.")
            return

        days = int(days_str)
        if days > TOTAL_DAYS:
            messagebox.showerror("Input Error", f"Days attended cannot exceed total days ({TOTAL_DAYS}).")
            return

        self.students[name] = days
        self.refresh_listbox()
        self.entry_name.delete(0, tk.END)
        self.entry_days.delete(0, tk.END)

    def refresh_listbox(self):
        self.listbox.delete(0, tk.END)
        for name, days in sorted(self.students.items()):
            percent = (days / TOTAL_DAYS) * 100
            self.listbox.insert(tk.END, f"{name}: {days} days attended ({percent:.2f}%)")

    def calculate_bunk(self):
        if not self.students:
            messagebox.showinfo("No Data", "No student data available.")
            return
        result = ""
        for name, days in sorted(self.students.items()):
            percent = (days / TOTAL_DAYS) * 100
            if percent < ATTENDANCE_THRESHOLD:
                bunk = 0
                status = "Below attendance threshold!"
            else:
                # Calculate max bunk days to keep attendance above threshold
                max_bunk = int(days - (ATTENDANCE_THRESHOLD / 100) * TOTAL_DAYS)
                bunk = max_bunk if max_bunk >= 0 else 0
                status = f"Can bunk {bunk} days."

            result += f"{name}: {status}\n"

        messagebox.showinfo("Bunk Days Calculation", result)

    def save_data(self):
        if not self.students:
            messagebox.showinfo("No Data", "No student data to save.")
            return
        file_path = filedialog.asksaveasfilename(defaultextension=".json",
                                                 filetypes=[("JSON files", "*.json"), ("All files", "*.*")])
        if file_path:
            with open(file_path, "w") as f:
                json.dump(self.students, f)
            messagebox.showinfo("Success", f"Data saved to {os.path.basename(file_path)}")

    def load_data(self):
        file_path = filedialog.askopenfilename(defaultextension=".json",
                                               filetypes=[("JSON files", "*.json"), ("All files", "*.*")])
        if file_path:
            with open(file_path, "r") as f:
                self.students = json.load(f)
            self.refresh_listbox()
            messagebox.showinfo("Success", f"Data loaded from {os.path.basename(file_path)}")

    def clear_all(self):
        self.students.clear()
        self.refresh_listbox()


if __name__ == "__main__":
    app = AttendanceCalculator()
    app.mainloop()
